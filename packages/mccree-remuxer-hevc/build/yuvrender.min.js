"use strict";

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

!function (e, t) {
  "object" == (typeof exports === "undefined" ? "undefined" : _typeof(exports)) && "object" == (typeof module === "undefined" ? "undefined" : _typeof(module)) ? module.exports = t() : "function" == typeof define && define.amd ? define("yuvrender", [], t) : "object" == (typeof exports === "undefined" ? "undefined" : _typeof(exports)) ? exports.yuvrender = t() : e.yuvrender = t();
}(window, function () {
  return function (e) {
    var t = {};function r(i) {
      if (t[i]) return t[i].exports;var o = t[i] = { i: i, l: !1, exports: {} };return e[i].call(o.exports, o, o.exports, r), o.l = !0, o.exports;
    }return r.m = e, r.c = t, r.d = function (e, t, i) {
      r.o(e, t) || Object.defineProperty(e, t, { configurable: !1, enumerable: !0, get: i });
    }, r.r = function (e) {
      Object.defineProperty(e, "__esModule", { value: !0 });
    }, r.n = function (e) {
      var t = e && e.__esModule ? function () {
        return e.default;
      } : function () {
        return e;
      };return r.d(t, "a", t), t;
    }, r.o = function (e, t) {
      return Object.prototype.hasOwnProperty.call(e, t);
    }, r.p = "", r(r.s = 0);
  }([function (e, t, r) {
    "use strict";
    Object.defineProperty(t, "__esModule", { value: !0 });var i = function () {
      function e(e, t) {
        for (var r = 0; r < t.length; r++) {
          var i = t[r];i.enumerable = i.enumerable || !1, i.configurable = !0, "value" in i && (i.writable = !0), Object.defineProperty(e, i.key, i);
        }
      }return function (t, r, i) {
        return r && e(t.prototype, r), i && e(t, i), t;
      };
    }();var o = function () {
      function e(t) {
        !function (e, t) {
          if (!(e instanceof t)) throw new TypeError("Cannot call a class as a function");
        }(this, e), t = t || {}, this.canvasElement = t.canvas || document.createElement("canvas"), this.contextOptions = t.contextOptions, this.type = t.type || "yuv420", this.customYUV444 = t.customYUV444, this.conversionType = t.conversionType || "rec601", this.width = t.width || 640, this.height = t.height || 320, this.animationTime = t.animationTime || 0, this._scaleRate = this.canvasElement.width / this.width, this.canvasElement.height = this.canvasElement.width / (this.width / this.height), this.initContextGL(), this.contextGL && (this.initProgram(), this.initBuffers(), this.initTextures()), "yuv420" === this.type ? this.drawNextOuptutPictureGL = function (e) {
          var t = this.contextGL,
              r = this.texturePosBuffer,
              i = this.uTexturePosBuffer,
              o = this.vTexturePosBuffer,
              a = this.yTextureRef,
              n = this.uTextureRef,
              u = this.vTextureRef,
              s = e.yData,
              f = e.uData,
              h = e.vData,
              x = this.width,
              c = this.height,
              v = e.yDataPerRow || x,
              l = e.yRowCnt || c,
              T = e.uDataPerRow || x / 2,
              R = e.uRowCnt || c / 2,
              A = e.vDataPerRow || T,
              d = e.vRowCnt || R;t.viewport(0, 0, this.canvasElement.width, this.canvasElement.height);var m = c / l,
              E = x / v,
              g = new Float32Array([E, 0, 0, 0, E, m, 0, m]);t.bindBuffer(t.ARRAY_BUFFER, r), t.bufferData(t.ARRAY_BUFFER, g, t.DYNAMIC_DRAW), this.customYUV444 ? (m = c / R, E = x / T) : (m = c / 2 / R, E = x / 2 / T);var p = new Float32Array([E, 0, 0, 0, E, m, 0, m]);t.bindBuffer(t.ARRAY_BUFFER, i), t.bufferData(t.ARRAY_BUFFER, p, t.DYNAMIC_DRAW), this.customYUV444 ? (m = c / d, E = x / A) : (m = c / 2 / d, E = x / 2 / A);var y = new Float32Array([E, 0, 0, 0, E, m, 0, m]);t.bindBuffer(t.ARRAY_BUFFER, o), t.bufferData(t.ARRAY_BUFFER, y, t.DYNAMIC_DRAW), t.activeTexture(t.TEXTURE0), t.bindTexture(t.TEXTURE_2D, a), t.texImage2D(t.TEXTURE_2D, 0, t.LUMINANCE, v, l, 0, t.LUMINANCE, t.UNSIGNED_BYTE, s), t.activeTexture(t.TEXTURE1), t.bindTexture(t.TEXTURE_2D, n), t.texImage2D(t.TEXTURE_2D, 0, t.LUMINANCE, T, R, 0, t.LUMINANCE, t.UNSIGNED_BYTE, f), t.activeTexture(t.TEXTURE2), t.bindTexture(t.TEXTURE_2D, u), t.texImage2D(t.TEXTURE_2D, 0, t.LUMINANCE, A, d, 0, t.LUMINANCE, t.UNSIGNED_BYTE, h), t.drawArrays(t.TRIANGLE_STRIP, 0, 4);
        } : "yuv422" === this.type && (this.drawNextOuptutPictureGL = function (e) {
          var t = this.contextGL,
              r = this.texturePosBuffer,
              i = this.textureRef,
              o = e.data,
              a = this.width,
              n = this.height,
              u = e.dataPerRow || 2 * a,
              s = e.rowCnt || n;t.viewport(0, 0, a, n);var f = n / s,
              h = a / (u / 2),
              x = new Float32Array([h, 0, 0, 0, h, f, 0, f]);t.bindBuffer(t.ARRAY_BUFFER, r), t.bufferData(t.ARRAY_BUFFER, x, t.DYNAMIC_DRAW), t.uniform2f(t.getUniformLocation(this.shaderProgram, "resolution"), u, n), t.activeTexture(t.TEXTURE0), t.bindTexture(t.TEXTURE_2D, i), t.texImage2D(t.TEXTURE_2D, 0, t.LUMINANCE, u, s, 0, t.LUMINANCE, t.UNSIGNED_BYTE, o), t.drawArrays(t.TRIANGLE_STRIP, 0, 4);
        });
      }return i(e, [{ key: "isWebGL", value: function value() {
          return this.contextGL;
        } }, { key: "initContextGL", value: function value() {
          for (var e = this.canvasElement, t = null, r = ["webgl", "experimental-webgl", "moz-webgl", "webkit-3d"], i = 0; !t && i < r.length;) {
            var o = r[i];try {
              t = this.contextOptions ? e.getContext(o, this.contextOptions) : e.getContext(o);
            } catch (e) {
              t = null;
            }t && "function" == typeof t.getParameter || (t = null), ++i;
          }this.contextGL = t;
        } }, { key: "initProgram", value: function value() {
          var e = this.contextGL,
              t = void 0,
              r = void 0;"yuv420" === this.type ? (t = ["attribute vec4 vertexPos;", "attribute vec4 texturePos;", "attribute vec4 uTexturePos;", "attribute vec4 vTexturePos;", "varying vec2 textureCoord;", "varying vec2 uTextureCoord;", "varying vec2 vTextureCoord;", "uniform mat4 u_scaleMatrix;", "void main()", "{", "  gl_Position = vertexPos;", "  textureCoord = texturePos.xy;", "  uTextureCoord = uTexturePos.xy;", "  vTextureCoord = vTexturePos.xy;", "}"].join("\n"), r = ["precision highp float;", "varying highp vec2 textureCoord;", "varying highp vec2 uTextureCoord;", "varying highp vec2 vTextureCoord;", "uniform sampler2D ySampler;", "uniform sampler2D uSampler;", "uniform sampler2D vSampler;", "uniform mat4 YUV2RGB;", "void main(void) {", "  highp float y = texture2D(ySampler,  textureCoord).r;", "  highp float u = texture2D(uSampler,  uTextureCoord).r;", "  highp float v = texture2D(vSampler,  vTextureCoord).r;", "  gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;", "}"].join("\n")) : "yuv422" === this.type && (t = ["attribute vec4 vertexPos;", "attribute vec4 texturePos;", "varying vec2 textureCoord;", "void main()", "{", "  gl_Position = vertexPos;", "  textureCoord = texturePos.xy;", "}"].join("\n"), r = ["precision highp float;", "varying highp vec2 textureCoord;", "uniform sampler2D sampler;", "uniform highp vec2 resolution;", "uniform mat4 YUV2RGB;", "void main(void) {", "  highp float texPixX = 1.0 / resolution.x;", "  highp float logPixX = 2.0 / resolution.x;", "  highp float logHalfPixX = 4.0 / resolution.x;", "  highp float steps = floor(textureCoord.x / logPixX);", "  highp float uvSteps = floor(textureCoord.x / logHalfPixX);", "  highp float y = texture2D(sampler, vec2((logPixX * steps) + texPixX, textureCoord.y)).r;", "  highp float u = texture2D(sampler, vec2((logHalfPixX * uvSteps), textureCoord.y)).r;", "  highp float v = texture2D(sampler, vec2((logHalfPixX * uvSteps) + texPixX + texPixX, textureCoord.y)).r;", "  gl_FragColor = vec4(y, u, v, 1.0) * YUV2RGB;", "}"].join("\n"));var i = [];i = "rec709" == this.conversionType ? [1.16438, 0, 1.79274, -.97295, 1.16438, -.21325, -.53291, .30148, 1.16438, 2.1124, 0, -1.1334, 0, 0, 0, 1] : [1.16438, 0, 1.59603, -.87079, 1.16438, -.39176, -.81297, .52959, 1.16438, 2.01723, 0, -1.08139, 0, 0, 0, 1];var o = e.createShader(e.VERTEX_SHADER);e.shaderSource(o, t), e.compileShader(o), e.getShaderParameter(o, e.COMPILE_STATUS) || console.log("Vertex shader failed to compile: " + e.getShaderInfoLog(o));var a = e.createShader(e.FRAGMENT_SHADER);e.shaderSource(a, r), e.compileShader(a), e.getShaderParameter(a, e.COMPILE_STATUS) || console.log("Fragment shader failed to compile: " + e.getShaderInfoLog(a));var n = e.createProgram();e.attachShader(n, o), e.attachShader(n, a), e.linkProgram(n), e.getProgramParameter(n, e.LINK_STATUS) || console.log("Program failed to compile: " + e.getProgramInfoLog(n)), e.useProgram(n);var u = e.getUniformLocation(n, "YUV2RGB");e.uniformMatrix4fv(u, !1, i), this.shaderProgram = n;
        } }, { key: "initBuffers", value: function value() {
          var e = this.contextGL,
              t = this.shaderProgram,
              r = e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER, r), e.bufferData(e.ARRAY_BUFFER, new Float32Array([1, 1, -1, 1, 1, -1, -1, -1]), e.STATIC_DRAW);var i = e.getAttribLocation(t, "vertexPos");if (e.enableVertexAttribArray(i), e.vertexAttribPointer(i, 2, e.FLOAT, !1, 0, 0), this.animationTime) {
            var o = this.animationTime,
                a = 0;!function r() {
              var i = 1 * (a += 15) / o;a >= o ? i = 1 : setTimeout(r, 15);var n = -1 * i,
                  u = 1 * i,
                  s = e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER, s), e.bufferData(e.ARRAY_BUFFER, new Float32Array([u, u, n, u, u, n, n, n]), e.STATIC_DRAW);var f = e.getAttribLocation(t, "vertexPos");e.enableVertexAttribArray(f), e.vertexAttribPointer(f, 2, e.FLOAT, !1, 0, 0);try {
                e.drawArrays(e.TRIANGLE_STRIP, 0, 4);
              } catch (e) {
                console.log(e);
              }
            }();
          }var n = e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER, n), e.bufferData(e.ARRAY_BUFFER, new Float32Array([1, 0, 0, 0, 1, 1, 0, 1]), e.STATIC_DRAW);var u = e.getAttribLocation(t, "texturePos");if (e.enableVertexAttribArray(u), e.vertexAttribPointer(u, 2, e.FLOAT, !1, 0, 0), this.texturePosBuffer = n, "yuv420" === this.type) {
            var s = e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER, s), e.bufferData(e.ARRAY_BUFFER, new Float32Array([1, 0, 0, 0, 1, 1, 0, 1]), e.STATIC_DRAW);var f = e.getAttribLocation(t, "uTexturePos");e.enableVertexAttribArray(f), e.vertexAttribPointer(f, 2, e.FLOAT, !1, 0, 0), this.uTexturePosBuffer = s;var h = e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER, h), e.bufferData(e.ARRAY_BUFFER, new Float32Array([1, 0, 0, 0, 1, 1, 0, 1]), e.STATIC_DRAW);var x = e.getAttribLocation(t, "vTexturePos");e.enableVertexAttribArray(x), e.vertexAttribPointer(x, 2, e.FLOAT, !1, 0, 0), this.vTexturePosBuffer = h;
          }
        } }, { key: "initTextures", value: function value() {
          var e = this.contextGL,
              t = this.shaderProgram;if ("yuv420" === this.type) {
            var r = this.initTexture(),
                i = e.getUniformLocation(t, "ySampler");e.uniform1i(i, 0), this.yTextureRef = r;var o = this.initTexture(),
                a = e.getUniformLocation(t, "uSampler");e.uniform1i(a, 1), this.uTextureRef = o;var n = this.initTexture(),
                u = e.getUniformLocation(t, "vSampler");e.uniform1i(u, 2), this.vTextureRef = n;
          } else if ("yuv422" === this.type) {
            var s = this.initTexture(),
                f = e.getUniformLocation(t, "sampler");e.uniform1i(f, 0), this.textureRef = s;
          }
        } }, { key: "initTexture", value: function value() {
          var e = this.contextGL,
              t = e.createTexture();return e.bindTexture(e.TEXTURE_2D, t), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MAG_FILTER, e.NEAREST), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MIN_FILTER, e.NEAREST), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_S, e.CLAMP_TO_EDGE), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_T, e.CLAMP_TO_EDGE), e.bindTexture(e.TEXTURE_2D, null), t;
        } }, { key: "drawNextOutputPicture", value: function value(e, t, r, i) {
          this.contextGL ? this.drawNextOuptutPictureGL(e, t, r, i) : this.drawNextOutputPictureRGBA(e, t, r, i);
        } }, { key: "drawNextOutputPictureRGBA", value: function value(e, t, r, i) {
          var o = i,
              a = this.canvasElement.getContext("2d"),
              n = a.getImageData(0, 0, e, t);n.data.set(o), null === r ? a.putImageData(n, 0, 0) : a.putImageData(n, -r.left, -r.top, 0, 0, r.width, r.height);
        } }]), e;
    }();t.default = o;
  }]);
});